generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id              String             @id @default(cuid())
  name            String?
  password        String?
  email           String?            @unique
  emailVerified   DateTime?
  image           String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  // Role-based access control
  role            String             @default("user")  // "user" | "admin"

  // Baseline assessment tracking
  baselineCompleted    Boolean   @default(false)
  baselineCompletedAt  DateTime?
  baselineQuizId       String?

  quizzes         Quiz[]
  userAnswers     UserAnswer[]
  userCellMastery UserCellMastery[]
  engineLogs      EngineLog[]
  abilityHistory  AbilityHistory[]
  questionReviews QuestionReview[]
  feedbackLogs    FeedbackLog[]
  learnerPreferences LearnerPreferences?
  knowledgeGaps   KnowledgeGap[]
}

model Cell {
  id             String          @id @default(cuid())
  name           String          
  difficulty_b   Float           @default(0)
  discrimination_a Float         @default(1)
  questions      Question[]
  userMastery    UserCellMastery[]
  abilityHistory  AbilityHistory[]
}

model Question {
  id               String         @id @default(cuid())
  text             String
  explanation      String?
  cellId           String
  cell             Cell           @relation(fields: [cellId], references: [id])

  // IRT Parameters (2PL - existing)
  difficulty_b     Float          @default(0)
  discrimination_a Float          @default(1)

  // 3PL Extension (NEW)
  guessing_c       Float          @default(0.0)     // Pseudo-chance level (0-0.35)
  irtModel         String         @default("2PL")   // "2PL" or "3PL"

  // Exposure control (Sympson-Hetter)
  exposureCount    Int            @default(0)
  maxExposure      Int            @default(10)
  lastUsed         DateTime?
  isActive         Boolean        @default(true)
  retiredAt        DateTime?
  retirementReason String?

  // Calibration tracking
  responseCount    Int            @default(0)
  correctRate      Float?
  lastCalibrated   DateTime?
  calibrationSampleSize Int?                       // Sample size used for calibration
  calibrationDate       DateTime?                   // Last calibration date

  answerOptions    AnswerOption[]
  userAnswers      UserAnswer[]
  reviews          QuestionReview[]

  @@index([cellId, isActive])
  @@index([exposureCount])
  @@index([lastUsed])
  @@index([irtModel])
}

model AnswerOption {
  id         String   @id @default(cuid())
  text       String
  isCorrect  Boolean  @default(false)
  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model Quiz {
  id          String       @id @default(cuid())
  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  status      String       @default("in-progress")
  createdAt   DateTime     @default(now())
  userAnswers UserAnswer[]
  startedAt   DateTime     @default(now())
  completedAt DateTime?
  engineLogs      EngineLog[]

  // Quiz settings
  explorationParam Float?   @default(0.5)
  timerMinutes      Int?
  maxQuestions     Int?     @default(10)
  selectedCells    String?
  topicSelection   String?  @default("system")

  // Quiz type: "baseline" or "regular"
  quizType         String   @default("regular")

  // A/B Testing
  abTestVariant    String?  // 'A' | 'B' | null (not in test)
  abTestName       String?  // Name of the test this quiz is part of

  @@index([abTestVariant, abTestName])
}

model UserCellMastery {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  cellId         String
  cell           Cell     @relation(fields: [cellId], references: [id], onDelete: Cascade)
  ability_theta  Float    @default(0)
  selection_count Int     @default(0)
  mastery_status Int      @default(0)

  sem            Float?              
  confidence     Float?              
  lastEstimated  DateTime?           
  responseCount  Int     @default(0) 
  
  updatedAt      DateTime @updatedAt

  @@unique([userId, cellId])
}

model UserAnswer {
  id               String   @id @default(cuid())
  quizId           String
  quiz             Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  questionId       String
  question         Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  selectedOptionId String
  isCorrect        Boolean
  createdAt        DateTime @default(now())
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  responseTime        Int?      // Time taken to answer in milliseconds
  abilityAtTime       Float?    // User's ability estimate when question was answered
  questionDisplayedAt DateTime? // When question was shown to user (for engagement tracking)
}

model EngineLog {
  id        String   @id @default(cuid())
  userId    String
  quizId    String
  eventType String   // 'question_selected', 'answer_processed', 'mastery_achieved', etc.
  data      String   // JSON string with event-specific data
  duration  Int?     // milliseconds (optional)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([userId, quizId])
  @@index([eventType])
  @@index([createdAt])
}

model IRTParameterHistory {
  id               String   @id @default(cuid())
  entityType       String   
  entityId         String   
  difficulty_b     Float
  discrimination_a Float
  reason           String?  
  updatedAt        DateTime @default(now())

  @@index([entityType, entityId])
  @@index([updatedAt])
}

model AbilityHistory {
  id            String   @id @default(cuid())
  userId        String
  cellId        String
  ability_theta Float
  confidence    Float?
  quizId        String?
  updatedAt     DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  cell Cell @relation(fields: [cellId], references: [id], onDelete: Cascade)

  @@index([userId, cellId])
  @@index([updatedAt])
}

model QuestionReview {
  id              String   @id @default(cuid())
  userId          String
  questionId      String
  lastReviewed    DateTime
  reviewCount     Int      @default(0)
  easinessFactor  Float    @default(2.5)
  interval        Int      @default(1)      // days until next review
  nextReviewDate  DateTime
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([userId, questionId])
  @@index([userId, nextReviewDate])
  @@index([nextReviewDate])
}

// LLM-Based Personalized Feedback Models

model FeedbackLog {
  id            String   @id @default(cuid())
  userId        String
  quizId        String
  feedbackText  String   // Generated feedback content
  feedbackType  String   @default("quiz_summary") // quiz_summary, dashboard, etc.
  tokensUsed    Int      // Track API costs (input + output)
  responseTime  Int      // Performance monitoring (ms)
  usedCache     Boolean  @default(false)
  modelUsed     String   // gemini-2.5-flash, template, etc.
  createdAt     DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([quizId])
  @@index([createdAt])
  @@index([modelUsed])
}

model LearnerPreferences {
  id                String   @id @default(cuid())
  userId            String   @unique
  feedbackDetail    String   @default("balanced") // concise, balanced, detailed
  focusAreas        String?  // JSON array: ["conceptual", "procedural", "application"]
  motivationStyle   String   @default("growth")   // growth, achievement, autonomy
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model KnowledgeGap {
  id             String   @id @default(cuid())
  userId         String
  topicId        String   // cellId reference
  gapDescription String   // LLM-identified knowledge gap
  severity       String   @default("moderate") // minor, moderate, critical
  addressed      Boolean  @default(false)
  identifiedAt   DateTime @default(now())
  addressedAt    DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, topicId])
  @@index([addressed])
  @@index([severity])
}